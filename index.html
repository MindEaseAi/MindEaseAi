<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Calm Space</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
:root{
  --mint:#6fd3c4;
  --mint-soft:rgba(111,211,196,0.25);
  --glass:rgba(255,255,255,0.07);
}
html,body{
  margin:0;
  height:100%;
  background:radial-gradient(circle at top,#081615,#020807);
  font-family:system-ui,-apple-system,Segoe UI,sans-serif;
  color:#eaf8f4;
  overflow:hidden;
}
canvas{position:fixed;inset:0}
.ui{
  position:absolute;
  inset:0;
  display:flex;
  align-items:center;
  justify-content:center;
  flex-direction:column;
}
.panel{
  width:92%;
  max-width:760px;
  padding:44px;
  border-radius:36px;
  background:linear-gradient(180deg,rgba(255,255,255,0.09),rgba(255,255,255,0.03));
  backdrop-filter:blur(30px);
  box-shadow:0 40px 120px rgba(0,0,0,0.45);
  text-align:center;
}
h1{
  font-weight:500;
  letter-spacing:0.5px;
  margin-bottom:12px;
}
.sub{
  opacity:0.75;
  font-size:15px;
  margin-bottom:28px;
}
.game{
  min-height:220px;
  display:flex;
  flex-direction:column;
  align-items:center;
  justify-content:center;
  gap:22px;
}
button{
  margin-top:30px;
  padding:14px 42px;
  border-radius:999px;
  border:none;
  background:linear-gradient(135deg,#7de3d4,#4fbdb0);
  color:#04221d;
  font-size:16px;
  cursor:pointer;
}
button:active{transform:scale(0.97)}
.hidden{display:none}
/* Interaction visuals */
.orb{
  width:130px;
  height:130px;
  border-radius:50%;
  background:radial-gradient(circle at 30% 30%,#c8fff5,#4fbdb0);
  box-shadow:0 0 80px var(--mint-soft);
  transition:transform 1.5s ease;
}
.hold{
  transition:none;
}
.trace{
  width:100%;
  height:160px;
  border-radius:24px;
  background:rgba(255,255,255,0.05);
  position:relative;
}
.path{
  position:absolute;
  inset:20px;
  border:2px dashed rgba(255,255,255,0.15);
  border-radius:100px;
}
/* Glow for tracing */
.glow {
  position: fixed;
  width: 22px;
  height: 22px;
  border-radius: 50%;
  pointer-events: none;
  background: radial-gradient(circle, rgba(140,255,240,0.8), rgba(140,255,240,0.1));
  box-shadow: 0 0 30px rgba(140,255,240,0.6);
  transform: translate(-50%, -50%);
  animation: fade 1.6s forwards;
}
@keyframes fade {
  to { opacity: 0; transform: translate(-50%, -50%) scale(2.2); }
}
/* Companion */
#companion{
  position:fixed;
  bottom:40px;
  left:50%;
  transform:translateX(-50%);
  pointer-events:none;
  z-index:10;
}
.presence{
  width:120px;
  height:180px;
  border-radius:60px 60px 80px 80px;
  background:radial-gradient(circle at 50% 20%, rgba(180,255,240,0.9), rgba(100,200,180,0.25), rgba(20,40,35,0.1));
  box-shadow:0 0 80px rgba(140,255,240,0.35), inset 0 0 40px rgba(255,255,255,0.2);
  animation: breathe 7s ease-in-out infinite;
  opacity:0.9;
}
@keyframes breathe{
  0%,100%{ transform:translateY(0) scale(1); }
  50%{ transform:translateY(-10px) scale(1.04); }
}
/* Paywall */
#paywall{
  position:fixed;
  inset:0;
  display:flex;
  align-items:center;
  justify-content:center;
  background:rgba(0,0,0,0.6);
  z-index:20;
}
#paywall .panel{
  max-width:500px;
  text-align:center;
}
.best{
  background:linear-gradient(135deg,#9fffe8,#5fd0bf);
  color:#022;
}
</style>
</head>
<body>

<canvas id="aurora"></canvas>

<div class="ui">
  <div class="panel">
    <h1>Calm Space</h1>
    <div class="sub">Move slowly. Thereâ€™s nothing to finish.</div>
    <div class="game" id="game"></div>
    <button id="next">Begin Session</button>
    <div id="companion">
      <div class="presence"></div>
    </div>
  </div>
</div>

<div id="paywall" class="hidden">
  <div class="panel">
    <h1>Continue Your Calm</h1>
    <div class="sub">
      Youâ€™ve completed your free sessions ðŸŒ¿<br>Choose a plan to continue
    </div>
    <button onclick="fakePay('weekly')">Weekly â€“ $3.99</button><br><br>
    <button onclick="fakePay('monthly')">Monthly â€“ $9.99</button><br><br>
    <button class="best" onclick="fakePay('yearly')">Yearly â€“ $59.99</button>
    <div class="sub" style="margin-top:24px;opacity:.6">Demo mode â€“ no real charge yet</div>
  </div>
</div>

<script>
/* ================= SESSION LIMIT ================= */
const MAX_FREE = 3;
let used = Number(localStorage.getItem("calm_sessions") || 0);
function canStartSession(){ return used < MAX_FREE; }
function recordSession(){ used++; localStorage.setItem("calm_sessions", used); }

/* ================= AUDIO ================= */
let audioCtx, masterGain;
function startAudio(){
  audioCtx=new (window.AudioContext||window.webkitAudioContext)();
  masterGain=audioCtx.createGain();
  masterGain.gain.value=0.03;
  masterGain.connect(audioCtx.destination);

  for(let i=0;i<4;i++){
    const o=audioCtx.createOscillator();
    o.frequency.value=60+Math.random()*80;
    const g=audioCtx.createGain();
    g.gain.value=0;
    o.connect(g).connect(masterGain);
    o.start();
    g.gain.linearRampToValueAtTime(1,audioCtx.currentTime+5);
  }

  // Soft noise
  const buf = audioCtx.createBuffer(1,audioCtx.sampleRate*3,audioCtx.sampleRate);
  const data = buf.getChannelData(0);
  for(let i=0;i<data.length;i++) data[i]=(Math.random()*2-1)*0.02;
  const noise = audioCtx.createBufferSource();
  noise.buffer=buf;
  noise.loop=true;
  const filter=audioCtx.createBiquadFilter();
  filter.type="lowpass"; filter.frequency.value=600;
  const g2=audioCtx.createGain(); g2.gain.value=0.015;
  noise.connect(filter).connect(g2).connect(masterGain);
  noise.start();
}

/* ================= GAMES ================= */
const gameEl=document.getElementById("game");
const nextBtn=document.getElementById("next");

const games=[
  ()=>{ // Hold orb
    gameEl.innerHTML=`<div>Press and hold the light.</div><div class="orb hold" id="holdOrb"></div>`;
    const orb=document.getElementById("holdOrb");
    orb.onpointerdown=()=>orb.style.transform="scale(1.4)";
    orb.onpointerup=orb.onpointerleave=()=>orb.style.transform="scale(1)";
  },
  ()=>{ // Drag orb
    gameEl.innerHTML=`<div>Gently drag the orb.</div><div class="orb" id="dragOrb"></div>`;
    const orb=document.getElementById("dragOrb");
    let down=false;
    orb.onpointerdown=()=>down=true;
    document.onpointerup=()=>down=false;
    document.onpointermove=e=>{ if(down){ orb.style.transform=`translate(${e.movementX}px,${e.movementY}px)`; } }
  },
  ()=>{ // Trace
    gameEl.innerHTML=`<div>Trace the path slowly.</div><div class="trace"><div class="path"></div></div>`;
  },
  ()=>{ // Stillness
    gameEl.innerHTML=`<div>Rest attention on the light.</div><div class="orb"></div>`;
  }
];

let index=-1;
nextBtn.onclick=()=>{
  if(!canStartSession()){ showPaywall(); return; }
  recordSession();
  index++;
  if(index===0) startAudio();
  if(index>=games.length){
    gameEl.innerHTML="Stay as long as you like.";
    nextBtn.classList.add("hidden");
    return;
  }
  games[index]();
};

/* ================= TAP/BREATH SYNC ================= */
let taps=[];
document.addEventListener("pointerdown",()=>{ const now=performance.now(); taps.push(now); if(taps.length>6) taps.shift(); });
function breathingRate(){ 
  if(taps.length<2) return 6;
  let intervals=[]; for(let i=1;i<taps.length;i++) intervals.push(taps[i]-taps[i-1]);
  let avg = intervals.reduce((a,b)=>a+b,0)/intervals.length;
  return Math.min(10,Math.max(3,60000/avg));
}

/* ================= COMPANION ================= */
const companion = document.querySelector(".presence");
setInterval(()=>{
  const rate = breathingRate();
  const speed = Math.max(4,Math.min(10,rate));
  companion.style.animationDuration = speed + "s";
  const closeness = 1-(speed-4)/6;
  companion.style.opacity = 0.6 + closeness*0.4;
  companion.style.transform = `scale(${0.95+closeness*0.08})`;
},600);

/* ================= GLOW TRAIL ================= */
document.addEventListener("pointermove", e=>{
  const g=document.createElement("div");
  g.className="glow";
  g.style.left=e.clientX+"px";
  g.style.top=e.clientY+"px";
  document.body.appendChild(g);
  setTimeout(()=>g.remove(),1600);
});

/* ================= PAYWALL ================= */
function showPaywall(){
  document.querySelector(".ui").classList.add("hidden");
  document.getElementById("paywall").classList.remove("hidden");
}
function fakePay(plan){
  alert("Membership unlocked ("+plan+") â€“ demo mode");
  localStorage.setItem("calm_sessions",0);
  location.reload();
}

/* ================= AURORA ================= */
const c=document.getElementById("aurora");
const ctx=c.getContext("2d");
function resize(){c.width=innerWidth;c.height=innerHeight}
resize();onresize=resize;
let t=0;
function draw(){
  t+=0.002;
  ctx.clearRect(0,0,c.width,c.height);
  for(let i=0;i<3;i++){
    const y=c.height*(0.3+i*0.2);
    ctx.beginPath();
    ctx.moveTo(0,y);
    for(let x=0;x<c.width;x+=40){
      ctx.lineTo(x,y+Math.sin(x*0.002+t*2+i)*80);
    }
    ctx.strokeStyle="rgba(111,211,196,0.18)";
    ctx.lineWidth=140;
    ctx.stroke();
  }
  requestAnimationFrame(draw);
}
draw();
</script>
</body>
</html>
